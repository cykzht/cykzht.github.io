(()=>{var o=class{constructor(t){this.box=null,this.boxSize={width:0,height:0},this.rows=0,this.dataList=[],this.indexs=[],this.idMap={},this.avatar=!1,this.speed=20,this.height=36,this.gapWidth=20,this.gapHeight=20,this.delayRange=5e3,this.align="center",this.animates=new Map,this.stageAnimates=new Map,this.timeouts=new Map,this.update(t)}_divisor(t){let i=.5;switch(t){case"half":i=.5;break;case"top":i=.3333333333333333;break;case"full":i=1;break;default:break}return i}_initBarrageList(){if(!this.box.querySelector(".barrage-list")){let t=document.createElement("div");t.className="barrage-list",t.setAttribute("style",`gap:${this.gapHeight}px;justify-content: ${this.align};display: flex;height: 100%;flex-direction: column;overflow: hidden;`);for(let i=0;i<this.rows;i++){let s=document.createElement("div");s.className=`barrage-list-${i}`,s.setAttribute("style",`height:${this.height}px;position:relative;`),t.appendChild(s),this.dataList[i]=[]}this.box.appendChild(t)}}_pushOne(t){let i=this.dataList.map(e=>e.length),s=Math.min(...i),a=i.findIndex(e=>e===s);this.dataList[a].push(t)}_pushList(t){this._sliceRowList(this.rows,t).forEach((i,s)=>{this.dataList[s]?this.dataList[s]=this.dataList[s].concat(...i):this.dataList[s]=i})}_sliceRowList(t,i){let s=[],a=Math.round(i.length/t);for(let e=0;e<t;e++){let h=[];e===t-1?h=i.slice(e*a):e===0?h=i.slice(0,a):h=i.slice(e*a,(e+1)*a),s.push(h)}return s}_dispatchItem(t,i,s){if(!t||this.idMap[t.id])return;this.idMap[t.id]=t.id;let a=this.box.querySelector(`.barrage-list-${i}`),e=document.createElement("div");e.className="danmu-item",e.setAttribute("style",` height:${this.height}px; padding: ${this.avatar?"4px 8px 4px 4px":"4px 8px"}; display:inline-flex; position: absolute; right: 0; background-color: var(--trm-danmu-bg-color,#fff); color: var(--trm-danmu-color,#000); border-radius: 32px; align-items: center; transform: translateX(100%);`),e.innerHTML=`
					${this.avatar?`<img class="danmu-avatar" style="display: inline-block;width:${this.height-8}px;height:${this.height-8}px;border-radius:50%;margin-right:6px;" src="${t.avatar}">`:""}
					<div class="danmu-text" style="text-wrap:nowrap;overflow:hidden;text-overflow:ellipsis;">${t.text}</div>`,a.appendChild(e);let{width:h}=e.getBoundingClientRect();e.style.width=`${h}px`;let d=(this.boxSize.width+h)/this.speed*1e3,p=(h+this.gapWidth)/(this.boxSize.width+h)*d;if(s<this.dataList[i].length){let n=e.animate({transform:["translateX(100%)",`translateX(-${this.gapWidth}px)`]},{duration:p});n.onfinish=()=>{this.stageAnimates.delete(n),this.indexs[i]=s+1,this._dispatchItem(this.dataList[i][s+1],i,s+1)},this.stageAnimates.set(n,n)}let r=e.animate({transform:["translateX(100%)",`translateX(-${this.boxSize.width}px)`]},{duration:d,fill:"forwards"});r.onfinish=()=>{this.animates.delete(r),e.remove(),e=null},this.animates.set(r,r)}_run(){let t=this.dataList.length;for(let i=0;i<t;i++){let s=this.dataList[i],a=this.indexs[i];if(!a&&a!==0&&(a=this.indexs[i]=0),s[a]){let e=setTimeout(()=>{this._dispatchItem(s[a],i,a),this.timeouts.delete(e)},Math.random()*this.delayRange);this.timeouts.set(e,e)}}}pause(){return this.animates.forEach(t=>t.pause()),this.stageAnimates.forEach(t=>t.pause()),this}play(){return this.animates.forEach(t=>t.play()),this.stageAnimates.forEach(t=>t.play()),this}cancel(){return this.animates.forEach(t=>t.cancel()),this.stageAnimates.forEach(t=>t.cancel()),this.timeouts.forEach(t=>clearTimeout(t)),this.animates.clear(),this.stageAnimates.clear(),this.timeouts.clear(),this}reset(){return this.dataList=[],this.indexs=[],this.idMap={},this.cancel(),this.box.querySelector(".barrage-list")&&this.box.removeChild(this.box.querySelector(".barrage-list")),this}update(t){let i=document.querySelector(t.el);if(i){let s=i.getBoundingClientRect();this.box=i,this.boxSize=s,this.speed=t.speed??this.speed,this.gapWidth=t.gapWidth??this.gapWidth,this.gapHeight=t.gapHeight??this.gapHeight,this.avatar=t.avatar??this.avatar,this.height=t.height??this.height,this.delayRange=t.delayRange??this.delayRange,this.align=t.align??this.align,this.rows=parseInt((s.height*this._divisor(t.mode??"half")/(this.height+this.gapHeight)).toString()),this.reset()}else throw new Error(`\u672A\u627E\u5230\u5BB9\u5668 ${t.el}`);return this}pushData(t){switch(this._initBarrageList(),Object.prototype.toString.apply(t)){case"[object Object]":this._pushOne(t);break;case"[object Array]":this._pushList(t);break}return this._run(),this}},l=new o(window.ASYNC_CONFIG.danmu);window.danMu=async t=>{l.update(window.ASYNC_CONFIG.danmu).pushData(await t()),window.ASYNC_CONFIG.swup&&document.addEventListener("swup:contentReplaced",async function(){l.update(window.ASYNC_CONFIG.danmu).pushData(await t())})}})();
